# Project Context: Freight Dispatch Simulator

## Project Overview

A Julia package for freight delivery optimization implementing three solution approaches: greedy heuristics, metaheuristic local search, and exact MILP optimization. Includes interactive visualization and comprehensive comparisons.

**Repository**: https://github.com/alexgoldhoorn/freight-dispatch-simulator
**Language**: Julia 1.6+
**License**: MIT

## Key Decisions & Architecture

### Solution Approaches (Core Design Decision)

The package presents **three equal solution approaches** rather than treating one as primary:

1. **Greedy Heuristics** (4 strategies: FCFS, Cost, Distance, OverallCost)
   - For: Real-time/online decisions, large problems (50+ freights)
   - Response: Milliseconds
   - Quality: 2-10% from optimal

2. **Local Search Metaheuristic** (swap-based neighborhood)
   - For: Batch planning, medium problems (10-50 freights)
   - Response: Seconds
   - Quality: 0-5% from optimal
   - **Recommended for most use cases** (best tradeoff)

3. **MILP Optimization** (JuMP + HiGHS)
   - For: Strategic planning, small problems (<20 freights)
   - Response: Minutes
   - Quality: Provably optimal

### Module Structure

```
src/
├── FreightDispatchSimulator.jl  # Main module, exports all
├── types.jl                      # Core data structures
├── distances.jl                  # Haversine calculations
├── strategies.jl                 # Greedy strategies (4 types)
├── dispatcher.jl                 # SimJulia dispatcher process
├── vehicle.jl                    # SimJulia vehicle process
├── simulation.jl                 # Discrete event simulation orchestration
├── MILPOptimizer.jl             # Exact optimization (JuMP/HiGHS)
├── LocalSearch.jl               # Metaheuristic (swap-based)
└── MapVisualization.jl          # Interactive HTML maps (PlotlyJS)
```

**Design Pattern**: Simulation-based for greedy (SimJulia discrete events), mathematical optimization for MILP, hybrid (greedy → local search) for metaheuristic.

### Visualization System

**Color-coded by vehicle** throughout:
- Route lines: Vehicle-specific color
- ⚫ Pickups: Circles (color-matched)
- ■ Deliveries: Squares (color-matched)
- ⬡ Bases: Hexagons (color-matched)
- ❌ Failed: Red X marks

**Implementation**: Plots.jl → PlotlyJS backend → HTML with hover info

### Data Format (CSV)

**Freights**: `id, weight_kg, pickup_lat, pickup_lon, delivery_lat, delivery_lon, pickup_time, delivery_time`
**Vehicles**: `id, start_lat, start_lon, capacity_kg, speed_km_per_hour` (optional: `base_lat, base_lon`)

All times in seconds (Unix epoch or relative). Coordinates in decimal degrees.

## Development History & Key Decisions

### Session 1: Initial Development
- Created from monolithic script to modular package
- Implemented 4 greedy strategies
- Added SimJulia discrete event simulation
- Created test datasets (US urban, longhaul, EU scenarios)

### Session 2: Visualization Improvements
- Problem: Route maps unclear (which vehicle → which freight?)
- Solution: Complete redesign with vehicle-specific colors for ALL elements
- Changed base markers from stars (unsupported) to hexagons
- Added informative titles with success/failure counts

### Session 3: Notebook Issues
- Problem: Jupyter environment activation hanging (>30 mins)
- Solution: Use `Pkg.activate(pwd())` instead of `"."`, document proper launch
- Fixed: Duplicate column names in leftjoin (added `makeunique=true`)
- Fixed: Cell type errors (markdown vs code confusion)
- Cleaned: test1 CSV data (removed inline comments, proper formatting)

### Session 4: MILP Integration
- Merged MILP optimization from feature branch
- Decision: Present greedy and MILP as **equal first-class approaches**
- Removed all "branch" or "updated" language for clean first-version feel
- Updated docs to focus on tradeoffs, not hierarchy

### Session 5: Metaheuristic Addition (Current)
- Added local search as middle ground between greedy and MILP
- Created comprehensive theory document (`SOLUTION_APPROACHES.md`)
- Decision: Local search is **recommended default** (best quality/cost balance)
- Updated comparison notebook to show all three approaches

## Important Code Patterns

### Adding a New Greedy Strategy

```julia
# In src/strategies.jl
struct NewStrategy <: DispatchStrategy end

function select_vehicle(strategy::NewStrategy, freight, available_vehicles, current_time)
    # Your selection logic
    # Return: best_vehicle or nothing
end
```

Then export in `FreightDispatchSimulator.jl`.

### Extending Local Search

Current implementation uses simple swap neighborhood. To add more move types:

```julia
# In src/LocalSearch.jl
function explore_neighborhood(assignment, freights, vehicles)
    # Try swaps (current)
    # Try relocations (move freight to different position)
    # Try 2-opt (reverse route segment)
    # Return: improved_assignment, delta_cost
end
```

### Adding Datasets

1. Create directory in `data/`
2. Add `freights.csv` and `vehicles.csv`
3. Ensure proper formatting (no inline comments!)
4. Test with: `Simulation(freights, vehicles, 3600.0, DistanceStrategy())`

## Testing & Validation

```bash
# Run full test suite
julia --project=. -e 'using Pkg; Pkg.test()'

# Quick smoke test
julia --project=. -e '
using FreightDispatchSimulator, CSV, DataFrames
freights = CSV.read("data/test0/freights.csv", DataFrame)
vehicles = CSV.read("data/test0/vehicles.csv", DataFrame)
Simulation(freights, vehicles, 3600.0, DistanceStrategy())
'
```

Expected: 2 freights, 13,842 km total distance

## Common Issues & Solutions

### Issue: Jupyter notebook cells hanging
**Cause**: Wrong working directory or environment
**Fix**: Launch with `julia --project=. -e 'using IJulia; notebook(dir=pwd())'`

### Issue: PlotlyJS marker shapes not showing
**Cause**: Not all Plots.jl markers supported by PlotlyJS backend
**Fix**: Use hexagons instead of star5, circles/squares work fine

### Issue: leftjoin creating duplicate columns
**Cause**: Both DataFrames have same column names
**Fix**: Add `makeunique=true` parameter

### Issue: MILP taking too long
**Cause**: Problem too large (>20 freights) or complex
**Fix**: Reduce time_limit or use local search instead

### Issue: Local search no improvement
**Cause**: Greedy already found local optimum (common on small problems)
**Fix**: Normal behavior, means greedy was good. Try larger dataset.

## Performance Expectations

Based on test datasets:

| Dataset | Size | Greedy | Local Search | MILP |
|---------|------|--------|--------------|------|
| test0 | 2F, 2V | 0.002s | 0.01s | 0.07s |
| Urban | 15F, 5V | 0.2s | 0.5s | 1-5s |
| Iberia | 15F, 5V | 0.2s | 1s | 1-10s |
| Large | 20F, 15V | 0.3s | 2s | 10-60s+ |

Gap to optimal: Greedy 2-10%, Local Search 0-5%, MILP 0%

## Future Extensions (Not Yet Implemented)

From `SOLUTION_APPROACHES.md` theory but not coded:

- **Simulated Annealing**: Better escape from local optima
- **Genetic Algorithm**: Population-based search
- **Tabu Search**: Memory-based search
- **Variable Neighborhood Search**: Systematic exploration
- **Time Window Constraints**: More realistic MILP model
- **Multi-trip Vehicles**: Vehicles handle multiple routes
- **Dynamic Reassignment**: Real-time re-optimization

## Documentation Files

- `README.md`: User-facing documentation, quick start, features
- `SOLUTION_APPROACHES.md`: Deep theoretical background, algorithms, math
- `examples.ipynb`: Greedy strategy comparison with visualizations
- `examples_milp_comparison.ipynb`: All three approaches comparison
- `.project_context.md` (this file): Development context, decisions, patterns

## Code Style & Conventions

- Follow Julia conventions (CamelCase for types, snake_case for functions)
- Format with JuliaFormatter: `julia --project=. -e 'using JuliaFormatter; format_file("file.jl")'`
- Document public functions with docstrings
- Use Git commits with Co-Authored-By: Claude Sonnet 4.5
- Keep README clean (no "updated" or "branch" language)
- Test before committing

## Git Workflow

```bash
# Standard workflow
git add -A
git commit -m "$(cat <<'EOF'
<Title>

<Description>

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
EOF
)"
```

Current branch: `main`
Remote: `origin/main`

## Dependencies (Key Ones)

- **SimJulia.jl**: Discrete event simulation framework
- **JuMP.jl**: Mathematical optimization modeling
- **HiGHS.jl**: MILP solver (open source, fast)
- **PlotlyJS.jl**: Interactive visualizations
- **DataFrames.jl**: Data manipulation
- **CSV.jl**: File I/O

## Package Metadata

- **Version**: 0.2.0
- **UUID**: 2f3a4b5c-6d7e-8f9a-b0c1-d2e3f4a5b6c7
- **Julia Compat**: 1.6+
- **Status**: Active development, production-ready for documented features

## Contact & Contribution

- Issues: https://github.com/alexgoldhoorn/freight-dispatch-simulator/issues
- PRs welcome, please discuss major changes first
- Format code before PR, ensure tests pass

---

**Last Updated**: 2026-01-22 (Session 5: Added local search and theory docs)
**Maintainer Context**: All core features complete. Future work: additional metaheuristics, advanced MILP constraints.
